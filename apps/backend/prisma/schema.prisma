// TikTok広告運用自動化システム - Prismaスキーマ

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 訴求マスタ（Appeal）
// ============================================================================

model Appeal {
  id                    String      @id @default(uuid())
  name                  String      @unique
  targetCPA             Float?
  allowableCPA          Float?
  targetFrontCPO        Float?
  allowableFrontCPO     Float?
  cvSpreadsheetUrl      String?
  frontSpreadsheetUrl   String?
  createdAt             DateTime    @default(now())
  updatedAt             DateTime    @updatedAt

  advertisers           Advertiser[]
  adTextTemplates       AdTextTemplate[]

  @@map("appeals")
}

// ============================================================================
// 広告文テンプレート（AdTextTemplate）
// ============================================================================

model AdTextTemplate {
  id          String    @id @default(uuid())
  appealId    String
  name        String    // テンプレート名（例: "新春セール"）
  text        String    // 広告文本体
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  appeal      Appeal    @relation(fields: [appealId], references: [id], onDelete: Cascade)

  @@map("ad_text_templates")
}

// ============================================================================
// 広告主（Advertiser）
// ============================================================================

model Advertiser {
  id                  String      @id @default(uuid())
  tiktokAdvertiserId  String      @unique
  name                String
  appealId            String?
  timezone            String      @default("UTC")
  currency            String      @default("USD")
  status              String      @default("ACTIVE")
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  appeal              Appeal?     @relation(fields: [appealId], references: [id], onDelete: SetNull)
  oauthTokens         OAuthToken[]
  campaigns           Campaign[]
  creatives           Creative[]
  experiments         Experiment[]
  userAdvertisers     UserAdvertiser[]
  adPerformances      AdPerformance[]
  adBudgetCaps        AdBudgetCap[]
  notifications       Notification[]

  @@map("advertisers")
}

// ============================================================================
// OAuth認証
// ============================================================================

model OAuthToken {
  id              String      @id @default(uuid())
  advertiserId    String      @unique
  accessToken     String      @db.Text
  refreshToken    String?     @db.Text
  expiresAt       DateTime
  scope           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  advertiser      Advertiser  @relation(fields: [advertiserId], references: [tiktokAdvertiserId], onDelete: Cascade)

  @@map("oauth_tokens")
}

// ============================================================================
// Campaign管理
// ============================================================================

model Campaign {
  id              String      @id @default(uuid())
  tiktokId        String      @unique
  advertiserId    String
  name            String
  objectiveType   String
  budgetMode      String?
  budget          Float?
  status          String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  advertiser      Advertiser  @relation(fields: [advertiserId], references: [id], onDelete: Cascade)
  adGroups        AdGroup[]
  metrics         Metric[]

  @@map("campaigns")
}

// ============================================================================
// AdGroup管理
// ============================================================================

model AdGroup {
  id              String      @id @default(uuid())
  tiktokId        String      @unique
  campaignId      String
  name            String
  placementType   String?
  budgetMode      String?
  budget          Float?
  bidType         String?
  bidPrice        Float?
  targeting       Json?
  schedule        Json?
  status          String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  campaign        Campaign    @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  ads             Ad[]
  metrics         Metric[]

  @@map("adgroups")
}

// ============================================================================
// Ad管理
// ============================================================================

model Ad {
  id              String      @id @default(uuid())
  tiktokId        String      @unique
  adgroupId       String
  name            String
  creativeId      String
  adText          String?
  callToAction    String?
  landingPageUrl  String?
  displayName     String?
  status          String
  reviewStatus    String?
  reviewMessage   String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  adGroup         AdGroup     @relation(fields: [adgroupId], references: [id], onDelete: Cascade)
  creative        Creative    @relation(fields: [creativeId], references: [id], onDelete: Restrict)
  metrics         Metric[]
  performance     AdPerformance?
  budgetCap       AdBudgetCap?

  @@map("ads")
}

// ============================================================================
// Creative管理
// ============================================================================

model Creative {
  id              String      @id @default(uuid())
  advertiserId    String
  name            String
  tiktokVideoId   String?
  tiktokImageId   String?
  type            String
  url             String
  thumbnailUrl    String?
  filename        String
  fileSize        Int?
  duration        Int?
  width           Int?
  height          Int?
  aspectRatio     String?
  metadata        Json?
  status          String      @default("PROCESSING")
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  advertiser      Advertiser  @relation(fields: [advertiserId], references: [id], onDelete: Cascade)
  ads             Ad[]

  @@map("creatives")
}

// ============================================================================
// レポート・メトリクス
// ============================================================================

model Metric {
  id              String      @id @default(uuid())
  entityType      String
  campaignId      String?
  adgroupId       String?
  adId            String?
  statDate        DateTime
  impressions     Int         @default(0)
  clicks          Int         @default(0)
  spend           Float       @default(0)
  conversions     Int         @default(0)
  ctr             Float       @default(0)
  cpc             Float       @default(0)
  cpm             Float       @default(0)
  cpa             Float       @default(0)
  videoViews      Int         @default(0)
  videoWatched2s  Int         @default(0)
  videoWatched6s  Int         @default(0)
  registrationPath String?    // 登録経路（旧スマプラキャンペーン用）
  createdAt       DateTime    @default(now())

  campaign        Campaign?   @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  adGroup         AdGroup?    @relation(fields: [adgroupId], references: [id], onDelete: Cascade)
  ad              Ad?         @relation(fields: [adId], references: [id], onDelete: Cascade)

  @@index([campaignId, statDate], name: "metric_campaign_idx")
  @@index([adgroupId, statDate], name: "metric_adgroup_idx")
  @@index([adId, statDate], name: "metric_ad_idx")
  @@index([statDate], name: "metric_statdate_idx")
  @@index([registrationPath], name: "metric_registration_path_idx")
  @@map("metrics")
}

// ============================================================================
// ユーザー・権限管理
// ============================================================================

model User {
  id              String      @id @default(uuid())
  email           String      @unique
  name            String
  passwordHash    String?
  status          String      @default("ACTIVE")
  lastLoginAt     DateTime?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  userRoles       UserRole[]
  userAdvertisers UserAdvertiser[]
  experiments     Experiment[]
  changeLogs      ChangeLog[]

  @@map("users")
}

model Role {
  id              String      @id @default(uuid())
  name            String      @unique
  description     String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  userRoles       UserRole[]
  rolePermissions RolePermission[]

  @@map("roles")
}

model Permission {
  id              String      @id @default(uuid())
  name            String      @unique
  resource        String
  action          String
  description     String?
  createdAt       DateTime    @default(now())

  rolePermissions RolePermission[]

  @@map("permissions")
}

// 中間テーブル: User ←→ Role
model UserRole {
  userId          String
  roleId          String
  assignedAt      DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  role            Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
}

// 中間テーブル: Role ←→ Permission
model RolePermission {
  roleId          String
  permissionId    String
  assignedAt      DateTime    @default(now())

  role            Role        @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission      Permission  @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@map("role_permissions")
}

// 中間テーブル: User ←→ Advertiser
model UserAdvertiser {
  userId          String
  advertiserId    String
  assignedAt      DateTime    @default(now())

  user            User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  advertiser      Advertiser  @relation(fields: [advertiserId], references: [id], onDelete: Cascade)

  @@id([userId, advertiserId])
  @@map("user_advertisers")
}

// ============================================================================
// 変更履歴・監査ログ
// ============================================================================

model ChangeLog {
  id              String      @id @default(uuid())
  entityType      String
  entityId        String
  action          String
  userId          String?
  source          String      @default("MANUAL")
  beforeData      Json?
  afterData       Json?
  reason          String?
  createdAt       DateTime    @default(now())

  user            User?       @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([entityType, entityId], name: "changelog_entity_idx")
  @@index([userId], name: "changelog_user_idx")
  @@index([createdAt], name: "changelog_created_idx")
  @@map("change_logs")
}

// ============================================================================
// 実験フレームワーク（A/Bテスト・MAB）
// ============================================================================

model Experiment {
  id              String      @id @default(uuid())
  advertiserId    String
  name            String
  hypothesis      String?
  experimentType  String
  status          String      @default("DRAFT")
  startDate       DateTime?
  endDate         DateTime?
  config          Json?
  result          Json?
  winner          String?
  createdBy       String
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  advertiser      Advertiser  @relation(fields: [advertiserId], references: [id], onDelete: Cascade)
  creator         User        @relation(fields: [createdBy], references: [id], onDelete: Restrict)

  @@map("experiments")
}

// ============================================================================
// Webhook受信イベント
// ============================================================================

model WebhookEvent {
  id              String      @id @default(uuid())
  eventId         String      @unique
  eventType       String
  payload         Json
  signature       String?
  processed       Boolean     @default(false)
  processedAt     DateTime?
  error           String?
  createdAt       DateTime    @default(now())

  @@index([eventType], name: "webhook_event_type_idx")
  @@index([processed], name: "webhook_processed_idx")
  @@map("webhook_events")
}

// ============================================================================
// API呼び出しログ
// ============================================================================

model APILog {
  id              String      @id @default(uuid())
  endpoint        String
  method          String
  requestBody     Json?
  responseStatus  Int
  responseBody    Json?
  duration        Int
  advertiserId    String?
  userId          String?
  error           String?
  createdAt       DateTime    @default(now())

  @@index([endpoint], name: "apilog_endpoint_idx")
  @@index([responseStatus], name: "apilog_status_idx")
  @@index([createdAt], name: "apilog_created_idx")
  @@map("api_logs")
}

// ============================================================================
// 広告パフォーマンス最適化機能
// ============================================================================

// 広告パフォーマンス追跡
model AdPerformance {
  id                        String    @id @default(uuid())
  adId                      String    @unique
  advertiserId              String

  // 累計メトリクス
  totalSpend                Float     @default(0)      // 累計消化額
  totalImpressions          Int       @default(0)      // 累計インプレッション（リーチとして使用）
  totalClicks               Int       @default(0)      // 累計クリック数
  totalConversions          Int       @default(0)      // 累計CV数（Google Sheets基準）
  totalFrontSales           Int       @default(0)      // 累計フロント販売数

  // 過去最高パフォーマンス（インプレッション10万達成後に記録開始）
  bestCPA                   Float?                     // 過去最高CPA（低いほど良い）
  bestCPADate               DateTime?                  // 過去最高CPA記録日
  bestFrontCPO              Float?                     // 過去最高フロントCPO
  bestFrontCPODate          DateTime?                  // 過去最高フロントCPO記録日
  bestCTR                   Float?                     // 過去最高CTR
  bestCTRDate               DateTime?                  // 過去最高CTR記録日

  // 見直しトリガー用
  spendAtLastReview         Float     @default(0)      // 前回見直し時点の累計消化額
  lastReviewDate            DateTime?                  // 前回見直し日
  reviewCount               Int       @default(0)      // 見直し回数

  // インプレッション条件達成フラグ
  impressionThresholdMet    Boolean   @default(false)  // 累計インプレッション10万達成フラグ
  impressionThresholdMetAt  DateTime?                  // 達成日時

  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt

  ad                        Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)
  advertiser                Advertiser @relation(fields: [advertiserId], references: [id], onDelete: Cascade)

  @@index([advertiserId])
  @@index([impressionThresholdMet])
  @@map("ad_performances")
}

// 広告上限日予算設定
model AdBudgetCap {
  id                String    @id @default(uuid())
  adId              String    @unique
  advertiserId      String
  maxDailyBudget    Float                          // 上限日予算（円）
  enabled           Boolean   @default(true)       // 有効/無効
  startDate         DateTime?                      // 適用開始日
  endDate           DateTime?                      // 適用終了日
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  ad                Ad        @relation(fields: [adId], references: [id], onDelete: Cascade)
  advertiser        Advertiser @relation(fields: [advertiserId], references: [id], onDelete: Cascade)

  @@index([advertiserId])
  @@index([enabled])
  @@map("ad_budget_caps")
}

// 通知
model Notification {
  id                String    @id @default(uuid())
  type              String                          // 通知タイプ: CPA_DEVIATION, AD_REVIEW, BUDGET_CAP_APPLIED, BUDGET_CAP_REACHED, PERFORMANCE_DEGRADATION
  severity          String    @default("INFO")      // INFO, WARNING, CRITICAL
  advertiserId      String
  entityType        String?                         // AD, ADGROUP, CAMPAIGN
  entityId          String?                         // 対象エンティティID
  title             String                          // 通知タイトル
  message           String    @db.Text              // 通知本文
  metadata          Json?                           // 追加データ（パフォーマンス数値等）
  status            String    @default("UNREAD")    // UNREAD, READ（対応済みは物理削除）
  readAt            DateTime?                       // 既読日時
  createdAt         DateTime  @default(now())

  advertiser        Advertiser @relation(fields: [advertiserId], references: [id], onDelete: Cascade)

  @@index([advertiserId, status])
  @@index([type])
  @@index([severity])
  @@index([createdAt])
  @@map("notifications")
}

// ============================================================================
// 日中CPA最適化機能
// ============================================================================

// 日中チェックで停止した広告のログ（23:59に再開するため）
model IntradayPauseLog {
  id              String    @id @default(uuid())
  adId            String                          // 広告ID（TikTok ID）
  advertiserId    String                          // 広告主ID
  pauseDate       DateTime                        // 停止日（日付のみ、時刻は00:00:00）
  pauseTime       DateTime                        // 停止実行時刻
  pauseReason     String                          // 停止理由（CPA_EXCEEDED, NO_CV_WITH_PREVIOUS_CV等）
  todaySpend      Float                           // 停止時点の当日消化額
  todayCPA        Float?                          // 停止時点の当日CPA（CV=0の場合null）
  yesterdayCPA    Float?                          // 前日CPA（CV=0判定時の参考）
  targetCPA       Float                           // 目標CPA（参考用）
  allowableCPA    Float                           // 許容CPA（参考用）
  resumed         Boolean   @default(false)       // 再開済みフラグ
  resumeTime      DateTime?                       // 再開実行時刻
  createdAt       DateTime  @default(now())

  @@index([pauseDate, resumed])
  @@index([adId, pauseDate])
  @@map("intraday_pause_logs")
}

// 日中チェックで予算削減した広告セットのログ（翌0:00に復元するため）
model IntradayBudgetReductionLog {
  id              String    @id @default(uuid())
  adgroupId       String                          // 広告セットID（TikTok ID）
  campaignId      String?                         // キャンペーンID（CBO時）
  advertiserId    String                          // 広告主ID
  reductionDate   DateTime                        // 削減日（日付のみ、時刻は00:00:00）
  reductionTime   DateTime                        // 削減実行時刻
  originalBudget  Float                           // 削減前の予算
  reducedBudget   Float                           // 削減後の予算（50%）
  reductionRate   Float     @default(0.5)         // 削減率
  isCBO           Boolean   @default(false)       // CBO（キャンペーン予算）かどうか
  restored        Boolean   @default(false)       // 復元済みフラグ
  restoreTime     DateTime?                       // 復元実行時刻
  createdAt       DateTime  @default(now())

  @@index([reductionDate, restored])
  @@index([adgroupId, reductionDate])
  @@map("intraday_budget_reduction_logs")
}
