# TikTok広告自動化システム - エラー対策要件定義書

**作成日**: 2025年12月2日
**更新日**: 2025年12月3日
**目的**: システムで発生しうるエラーを網羅的に洗い出し、対策を検討・実装するための要件定義

---

## 1. 概要

### 1.1 背景
現在、管理者によるテスト運用中にエラーが発生した場合、都度修正を行っている。この方法ではシステム完成が遅れるため、事前に起こりうるエラーを洗い出し、優先度をつけて対策を実装する。

### 1.2 対象範囲
- バックエンド（NestJS）
- 外部API連携（TikTok API、Google Sheets API）
- データベース（PostgreSQL）
- スケジュールバッチ処理

---

## 2. エラー一覧と対策案

### 2.1 TikTok API関連エラー（優先度: 最高）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| T-01 | レートリミット超過 | 全TikTok API呼び出し | 600リクエスト/分を超過 | 対策なし | リトライ機構（指数バックオフ）+ リクエスト間隔制御 | 中 | ✅実装する |
| T-02 | アクセストークン期限切れ | 全TikTok API呼び出し | トークン無効化 | 手動で再認証 | 自動リフレッシュ機構 | 中 | ✅実装する |
| T-03 | APIタイムアウト | httpClient（30秒設定） | TikTok側の遅延・障害 | 30秒でタイムアウト | タイムアウト延長 + リトライ | 低 | ✅実装する |
| T-04 | 無効なAdvertiser ID | getCampaigns, getAds等 | 削除されたアカウント | **スケジュールバッチは対策済み**（try-catchでスキップ）。optimization.service.ts等は要確認 | 全箇所で同様のtry-catch処理を確認・追加 | 低 | ✅実装する |
| ~~T-05~~ | ~~API仕様変更~~ | ~~全API呼び出し~~ | ~~TikTokのAPI更新~~ | ~~対策なし~~ | ~~レスポンス形式の柔軟な処理 + ログ強化~~ | ~~中~~ | ❌対象外（トラブル対応） |
| T-06 | APIエラーコード処理 | 全API呼び出し | 各種エラーコード | 一律でthrow | エラーコード別の分岐処理 | 中 | ✅実装する |

---

### 2.2 Google Sheets API関連エラー（優先度: 高）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| G-01 | スプレッドシートアクセス拒否 | google-sheets.service.ts | 権限不足、URL間違い | エラーで停止 | エラーハンドリング + **エラー検知・通知** | 低 | ✅実装する |
| G-02 | シート名不一致 | getCVCount, getFrontSalesCount | シート名変更（TT_オプト等） | エラーで停止 | **エラー検知・通知** + 0件として継続 | 中 | ✅実装する |
| G-03 | 日付形式パースエラー | parseDate | 想定外の日付形式 | **対策済み**（nullを返してスキップ、処理継続） | （任意）スキップ時の警告ログ追加 | 低 | ✅実装する |
| G-04 | サービスアカウント認証失敗 | constructor | 認証情報JSONの問題 | 起動時エラー | 起動時バリデーション + 明確なエラーメッセージ | 低 | ✅実装する |
| G-05 | スプレッドシートURL未設定 | Appeal設定 | cvSpreadsheetUrl等がnull | エラーで停止 | **エラー検知・通知** + 実行時スキップ | 低 | ✅実装する |
| G-06 | シートデータ未更新 | countRegistrationPath | シート容量超過・更新停止 | 検知なし | **最新データ日付チェック + 未更新検知・通知** | 中 | ✅実装する（新規） |
| G-07 | 列ズレ | countRegistrationPath | 列が追加/削除されてE,F列以外にデータ | 誤カウント | **ヘッダー行検証 + 列位置自動補正** | 中 | ✅実装する（新規） |
| G-08 | スプレッドシートURL形式エラー | extractSpreadsheetId | 無効なURL形式 | エラーで停止 | **エラー検知・通知** + 処理スキップ | 低 | ✅実装する（新規） |

### 2.3 データベース関連エラー（優先度: 高）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| D-01 | 重複キー違反 | upsert操作全般 | 同時実行による競合 | エラーで停止 | トランザクション + リトライ | 中 | ✅実装する |
| D-02 | 外部キー制約違反 | Ad作成時 | Creativeが存在しない | **対策済み**（事前チェック + スキップして継続） | 追加対策不要 | - | ✅対策済み |
| D-03 | 接続タイムアウト | Prisma全般 | DB負荷・ネットワーク | エラーで停止 | コネクションプール設定 + リトライ | 中 | ✅実装する |
| D-04 | Campaign/AdGroup未検出 | scheduler.service.ts | 親レコード未同期 | **対策済み**（スキップして継続、warnログ出力） | 追加対策不要 | - | ✅対策済み |
| D-05 | メトリクス重複 | saveReportMetrics | 同日複数回実行 | 重複レコード作成 | upsert化 or 実行前削除 | 中 | ✅実装する |

### 2.4 予算最適化ロジックエラー（優先度: 高）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| O-01 | 広告名パース失敗 | parseAdName | 形式不正（/区切りが4未満） | nullでスキップ | 警告ログ + 管理画面通知 | 低 | ✅実装する |
| O-02 | Appeal未設定 | optimizeAdvertiser | 訴求が紐づいていない | エラーで停止 | スキップして次の広告主へ | 低 | ✅実装する |
| O-03 | Advertiser未検出 | optimizeAdvertiser | 削除された広告主 | エラーで停止 | スキップして継続 | 低 | ✅実装する |
| O-04 | 目標CPA/CPO未設定 | makeOptimizationDecision | Appeal設定不完全 | 計算エラー | 設定時バリデーション | 低 | ✅実装する |
| O-05 | Smart+判定ミス | isCreativeName | CR名判定ロジック漏れ | 誤った処理 | 判定ロジック強化 + テスト追加 | 中 | ✅実装する |
| O-06 | 予算更新API失敗 | increaseBudget | TikTok側制約 | エラーで停止 | リトライ + ロールバック | 中 | ✅実装する |

### 2.5 Creativeアップロードエラー（優先度: 中）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| C-01 | Vercel Blobアップロード失敗 | creative.service.ts | トークン無効、容量超過 | エラーで停止 | リトライ + エラーメッセージ明確化 | 低 | ✅実装する |
| C-02 | 動画処理タイムアウト | uploadVideoToTikTok | TikTok動画処理遅延 | 5回リトライ | リトライ回数・間隔調整 | 低 | ✅実装する |
| C-03 | サポート外ファイル形式 | uploadCreative | mp4/jpg/png以外 | BadRequestException | フロントエンドでも検証 | 低 | ✅実装する |
| C-04 | ファイルサイズ超過 | uploadCreative | 大きすぎるファイル | エラー | アップロード前サイズチェック | 低 | ✅実装する |

### 2.6 スケジュールバッチエラー（優先度: 中）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| S-01 | 同時実行競合 | scheduleDailyEntitySync | 前回ジョブ未完了 | スキップ（warn） | ロック機構強化 + 実行時間監視 | 中 | ✅実装する |
| S-02 | バッチタイムアウト | 全sync処理 | データ量過多 | タイムアウト | 分割処理 + 進捗ログ | 中 | ✅実装する |
| S-03 | 部分的同期失敗 | scheduler.service.ts | 一部広告主のみ失敗 | エラーカウント | 失敗分のリトライ + 通知 | 中 | ✅実装する |
| S-04 | ジョブ実行漏れ | Cron設定 | サーバー再起動等 | 対策なし | 実行履歴記録 + 手動実行機能 | 中 | ✅実装する |

### 2.7 認証・セキュリティエラー（優先度: 低）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| A-01 | CORS拒否 | main.ts | 許可されていないオリジン | **対策済み**（localhost, adsp-database.com, *.vercel.app を許可済み） | 追加対策不要 | - | ✅対策済み |
| A-02 | OAuthコールバック失敗 | getAccessToken | 認証コード期限切れ | **対策不要**（初回ログイン時のみ発生、発生確率極めて低い、トークン無期限のため再発なし） | - | - | ✅対策不要 |
| A-03 | localStorage認証切れ | フロントエンド | セッション期限 | **対策不要**（トークン無期限設定: 2099年まで有効） | - | - | ✅対策不要 |

---

### 2.8 設定・環境エラー（優先度: 低）

| ID | エラー名 | 発生箇所 | 原因 | 現状 | 対策案 | 実装難易度 | 実装 |
|----|----------|----------|------|------|--------|------------|------|
| E-01 | 環境変数未設定 | configService.get() | .env設定漏れ | 空文字で動作 | 起動時バリデーション | 低 | ✅実装する |
| E-02 | DBマイグレーション不整合 | Prisma起動時 | schema.prismaの変更がDBに未反映 | 起動エラー | デプロイ手順にマイグレーション実行を必須化（運用ルール） | 低 | ✅運用ルールで対応 |
| E-03 | 依存パッケージ非互換 | ビルド時 | npmパッケージのバージョン不一致 | **対策済み**（package-lock.json でバージョン固定済み） | 追加対策不要 | - | ✅対策済み |

---

## 3. 実装順序

### 3.1 Phase 1: 基盤整備（最優先）

日常的に発生し、システム停止につながるもの

| 順番 | ID | エラー名 | 理由 |
|------|-----|----------|------|
| 1 | T-01 | レートリミット対策 | 全API呼び出しに影響 |
| 2 | T-02 | トークン自動リフレッシュ | 全API呼び出しに影響 |
| 3 | T-03 | APIタイムアウト対策 | 全API呼び出しに影響 |
| 4 | T-04 | 無効なAdvertiser ID | 処理停止の防止 |
| 5 | T-06 | APIエラーコード処理 | エラー分類の基盤 |

### 3.2 Phase 2: Google Sheets対策（高優先）

新機能（広告パフォーマンス最適化）でGoogle Sheets CV数を使用するため必須

| 順番 | ID | エラー名 | 理由 |
|------|-----|----------|------|
| 6 | G-01 | アクセス拒否検知 | URL間違い・権限エラー検知 |
| 7 | G-02 | シート名不一致検知 | シート名変更の検知 |
| 8 | G-05 | URL未設定検知 | Appeal設定漏れ検知 |
| 9 | G-08 | URL形式エラー検知 | 無効なURL検知 |
| 10 | G-06 | シートデータ未更新検知 | 最新データがない場合の検知 |
| 11 | G-07 | 列ズレ検知・補正 | E,F列以外にデータがある場合の対応 |
| 12 | G-03 | 日付パースエラー | 警告ログ強化 |
| 13 | G-04 | サービスアカウント認証 | 起動時バリデーション |

### 3.3 Phase 3: 予算最適化・DB対策

| 順番 | ID | エラー名 | 理由 |
|------|-----|----------|------|
| 14 | O-01〜O-06 | 最適化ロジックエラー | 処理継続の保証 |
| 15 | D-01 | 重複キー違反 | 同時実行対策 |
| 16 | D-03 | 接続タイムアウト | リトライ機構 |
| 17 | D-05 | メトリクス重複 | upsert化 |

### 3.4 Phase 4: バッチ・その他

| 順番 | ID | エラー名 | 理由 |
|------|-----|----------|------|
| 18 | S-01〜S-04 | バッチ処理改善 | 安定性向上 |
| 19 | C-01〜C-04 | Creativeアップロード | ユーザー体験向上 |
| 20 | E-01 | 環境変数バリデーション | デプロイ安全性 |

---

## 4. Google Sheets エラー詳細仕様

### 4.1 G-06: シートデータ未更新検知

**目的**: シートの容量超過や更新停止により、最新データがない場合を検知

**検知ロジック**:
```
1. シートの最新日付（F列の最大日付）を取得
2. 現在日付から2日以上前の場合、警告を出力
3. ただし、処理は0件として継続（処理停止はしない）
```

**実装イメージ**:
```typescript
// countRegistrationPath() 内で追加
const latestDate = this.findLatestDateInSheet(rows);
const today = new Date();
const daysDiff = Math.floor((today.getTime() - latestDate.getTime()) / (1000 * 60 * 60 * 24));

if (daysDiff > 2) {
  this.logger.warn(
    `[G-06] シートデータが${daysDiff}日前から更新されていません: ${sheetName} (最新: ${latestDate.toISOString()})`
  );
  // 通知システムに送信（将来実装）
}
```

### 4.2 G-07: 列ズレ検知・自動補正

**目的**: E列（登録経路）とF列（登録日時）以外にデータが移動している場合を検知・補正

**現在のシート構造（想定）**:
```
A列    B列    C列    D列    E列          F列
...    ...    ...    ...    登録経路      登録日時
```

**検知ロジック**:
```
1. ヘッダー行（1行目）を取得
2. 「登録経路」「登録日時」のヘッダーを検索
3. E列、F列以外にある場合は列インデックスを動的に取得
4. 警告ログを出力して処理継続
```

**実装イメージ**:
```typescript
// getSheetDataWithCache() の後に追加
private findColumnIndices(headerRow: any[]): { pathIndex: number; dateIndex: number } {
  const pathIndex = headerRow.findIndex(cell =>
    cell && (cell.includes('登録経路') || cell.includes('流入経路'))
  );
  const dateIndex = headerRow.findIndex(cell =>
    cell && (cell.includes('登録日時') || cell.includes('日時') || cell.includes('日付'))
  );

  // デフォルトはE列(4), F列(5)
  if (pathIndex === -1 || dateIndex === -1) {
    this.logger.warn('[G-07] ヘッダーが見つかりません。デフォルト列(E,F)を使用します');
    return { pathIndex: 0, dateIndex: 1 }; // E:F範囲取得時のインデックス
  }

  if (pathIndex !== 4 || dateIndex !== 5) {
    this.logger.warn(
      `[G-07] 列ズレ検知: 登録経路=${String.fromCharCode(65 + pathIndex)}列, 登録日時=${String.fromCharCode(65 + dateIndex)}列`
    );
  }

  return { pathIndex, dateIndex };
}
```

**注意**: 現在はE:Fの範囲のみ取得しているため、列ズレがあると対応できない。
→ A:Z など広い範囲を取得するように変更が必要

### 4.3 G-08: スプレッドシートURL形式エラー

**目的**: 無効なURL形式を検知して、明確なエラーメッセージを出力

**検知ロジック**:
```
1. extractSpreadsheetId() でURL形式をチェック
2. 正規表現にマッチしない場合、具体的なエラーメッセージを出力
3. 0件として処理継続（処理停止はしない）
```

**実装イメージ**:
```typescript
private extractSpreadsheetId(url: string): string | null {
  if (!url) {
    this.logger.warn('[G-08] スプレッドシートURLが設定されていません');
    return null;
  }

  const match = url.match(/\/d\/([a-zA-Z0-9-_]+)/);
  if (!match) {
    this.logger.warn(`[G-08] 無効なスプレッドシートURL形式: ${url}`);
    return null;
  }
  return match[1];
}
```

### 4.4 エラー検知時の動作まとめ

| エラー | 検知方法 | 動作 | ログレベル |
|--------|----------|------|-----------|
| G-01 | API例外 | 0件で継続 | ERROR |
| G-02 | API例外（シート名） | 0件で継続 | ERROR |
| G-05 | URL null チェック | スキップ | WARN |
| G-06 | 最新日付チェック | 警告出力、処理継続 | WARN |
| G-07 | ヘッダー行解析 | 列補正、処理継続 | WARN |
| G-08 | URL正規表現 | 0件で継続 | WARN |

---

## 5. 実装方針

### 5.1 リトライ機構の共通化
- ✅ 専用のリトライユーティリティを作成する
- 設定値:
  - 最大リトライ回数: 3回
  - 初回待機時間: 1秒
  - 指数バックオフ係数: 2（1秒 → 2秒 → 4秒）

### 5.2 エラー通知
- ✅ 管理画面（ダッシュボード）に通知を表示
- 通知対象:
  - Google Sheets関連エラー（G-01〜G-08）
  - 予算最適化エラー（O-01〜O-06）
- 将来的にSlack連携を検討

### 5.3 ログ管理
- ログレベル基準:
  - ERROR: 処理が失敗した場合
  - WARN: 処理は継続するが注意が必要な場合
  - INFO: 正常処理の記録
  - DEBUG: 詳細なデバッグ情報

---

## 6. 決定事項記録欄

| 日付 | 決定者 | 決定内容 |
|------|--------|----------|
| 2025/12/03 | - | T-05（API仕様変更）はトラブル対応のため対象外とする |
| 2025/12/03 | - | G-06〜G-08を新規追加（シートデータ未更新、列ズレ、URL形式エラー） |
| 2025/12/03 | - | 全エラー項目を実装対象として確定 |

---

## 7. 次のステップ

1. [x] 要件定義の確定
2. [ ] Phase 1（TikTok API基盤整備）の実装
3. [ ] Phase 2（Google Sheets対策）の実装
4. [ ] Phase 3（予算最適化・DB対策）の実装
5. [ ] Phase 4（バッチ・その他）の実装

---

## 8. 追加懸念点（2025/12/03 コードレビューで発見）

### 8.1 緊急度: 高（対応済み）

以下の問題は2025/12/03に対応済み：

| ID | 問題 | 影響 | 対応内容 | ファイル |
|----|------|------|----------|----------|
| H-01 | DB操作がトランザクションなし | メトリクス削除後に挿入失敗でデータ消失 | `$transaction`で囲む | `tiktok.service.ts` |
| H-02 | 予算変更時のバリデーションなし | 予算がAPI制限を超える可能性 | 最小50円、最大5000万円のバリデーション追加 | `optimization.service.ts` |
| H-03 | グレースフルシャットダウンなし | ジョブ実行中の強制終了でデータ不整合 | SIGTERM/SIGINTハンドラー追加 | `main.ts` |
| H-04 | ロック機構の二重管理 | `batchJobLock`と`isSyncRunning`フラグが同期ズレ | フラグ削除、`batchJobLock`に統一 | `scheduler.service.ts` |

### 8.2 緊急度: 中（次回スプリントで対応予定）

| ID | 問題 | 影響 | 対策案 | ファイル | 実装難易度 |
|----|------|------|--------|----------|------------|
| M-01 | 一部APIにリトライロジックなし | 一時的なネットワーク障害で失敗 | `httpGetWithRetry`を使用 | `tiktok.service.ts:597, 2235` | 低 |
| M-02 | ページネーション中のエラーで全停止 | 途中でエラーが出ると残りのデータが同期されない | 個別エラーをキャッチして継続 | `tiktok.service.ts:494-496` | 中 |
| M-03 | キャッシュサイズ上限なし | メモリ使用量が増加し続ける | LRUキャッシュ実装、または定期クリア | `google-sheets.service.ts:39-40` | 中 |
| M-04 | SyncジョブとレポートジョブのDependencyなし | Sync完了前にレポート取得が始まる可能性 | ジョブ間の依存関係チェック追加 | `scheduler.service.ts:38-42, 487-490` | 中 |
| M-05 | TikTok APIレスポンス構造の検証なし | 不正なレスポンスでundefinedエラー | `response.data?.data?.list`の検証強化 | `tiktok.service.ts:446, 532` | 低 |
| M-06 | 日付範囲バリデーションなし | 不正な日付範囲でクエリエラー | startDate < endDate 検証追加 | `optimization.service.ts:517` | 低 |

### 8.3 緊急度: 低（計画的に対応）

| ID | 問題 | 影響 | 対策案 | ファイル |
|----|------|------|--------|----------|
| L-01 | ハードコードされたCTA ID | 全広告が同じCTA | 環境変数またはDB設定化 | `tiktok.service.ts:1187` |
| L-02 | ハードコードされたIdentity ID | Identity設定が固定 | Advertiser別に設定可能に | `tiktok.service.ts:1189-1190` |
| L-03 | ハードコードされたターゲティング | 日本/日本語のみ | 環境変数またはDB設定化 | `tiktok.service.ts:1062-1077` |
| L-04 | ハードコードされた閾値（AdPerformance） | 閾値調整不可 | 環境変数化 | `ad-performance.service.ts:6-16` |
| L-05 | ハードコードされた最適化パラメータ | Advertiser別調整不可 | Advertiser設定テーブル追加 | `optimization.service.ts:715-745` |
| L-06 | ハードコードされたシート名 | シート名変更不可 | Appeal設定に追加 | `google-sheets.service.ts:309, 329-330` |
| L-07 | ページサイズ固定（100） | 最適化の余地あり | 環境変数化（オプション） | `tiktok.service.ts` 複数箇所 |
| L-08 | サーキットブレーカーなし | API障害時に延々リトライ | サーキットブレーカーパターン実装 | 全APIサービス |
| L-09 | ジョブ失敗時の通知なし | 重要な失敗が気づかれない | Slack/メール通知連携 | `scheduler.service.ts` |
| L-10 | 二重実行防止チェックなし | 同日2回の最適化で予算過剰変更 | 実行履歴チェック追加 | `optimization.service.ts` |
| L-11 | メトリクス重複チェックなし | 同日複数回実行で重複 | upsert化またはunique制約 | `tiktok.service.ts:1527` |
| L-12 | 大量データのメモリ蓄積 | OOM発生の可能性 | ストリーミング処理に変更 | `tiktok.service.ts:459, 545` |
| L-13 | OAuthトークン取得にリトライなし | 認証失敗で全処理停止 | リトライ追加 | `tiktok.service.ts:163-186` |
| L-14 | センシティブデータのログ出力 | トークン漏洩リスク | ログマスキング追加 | `tiktok.service.ts:170, 277` |

### 8.4 実装優先度マトリクス

```
影響度
  高  │  M-02   M-04   │  H-01  H-02  H-03  H-04
      │  M-03          │
      ├────────────────┼────────────────────────
      │  L-08   L-09   │  M-01  M-05  M-06
  低  │  L-10   L-11   │  L-01〜L-07
      └────────────────┴────────────────────────
              低                   高
                    発生確率
```

---

## 付録: 参照ファイル一覧

| ファイル | 役割 |
|----------|------|
| `apps/backend/src/tiktok/tiktok.service.ts` | TikTok API連携 |
| `apps/backend/src/google-sheets/google-sheets.service.ts` | Google Sheets連携 |
| `apps/backend/src/optimization/optimization.service.ts` | 予算最適化ロジック |
| `apps/backend/src/jobs/scheduler.service.ts` | スケジュールバッチ |
| `apps/backend/src/creative/creative.service.ts` | Creativeアップロード |
| `apps/backend/src/ad-performance/ad-performance.service.ts` | 広告パフォーマンス管理 |
| `apps/backend/src/main.ts` | アプリケーションエントリポイント |
| `apps/backend/prisma/schema.prisma` | DBスキーマ |
