name: Intraday CPA Optimization

on:
  schedule:
    # 15:00 JST = 06:00 UTC（日中CPAチェック）
    - cron: '0 6 * * *'
    # 23:59 JST = 14:59 UTC（配信再開）
    - cron: '59 14 * * *'
    # 00:00 JST = 15:00 UTC（予算復元 - 翌日0時）
    - cron: '0 15 * * *'
  workflow_dispatch:
    inputs:
      job_type:
        description: '実行するジョブ'
        required: true
        type: choice
        options:
          - cpa-check
          - resume
          - budget-restore
      dry_run:
        description: 'ドライラン（実際の変更なし）'
        required: false
        type: boolean
        default: false

env:
  API_BASE_URL: https://tik-tok-ads-automation-backend.vercel.app
  # 日中CPA最適化から除外するアカウント（カンマ区切り）
  # NOTE: AI_1 (7468288053866561553) は一時的に除外中
  # NOTE: AI_2 (7523128243466551303) は一時的に除外中
  # NOTE: AI_3 (7543540647266074641) は一時的に除外中
  INTRADAY_EXCLUDED_ADVERTISERS: '7468288053866561553,7523128243466551303,7543540647266074641'

jobs:
  intraday-cpa-check:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 6 * * *' || github.event.inputs.job_type == 'cpa-check'
    steps:
      - name: Run Intraday CPA Check (15:00 JST)
        run: |
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          EXCLUDED="${{ env.INTRADAY_EXCLUDED_ADVERTISERS }}"

          # Build API URL with parameters
          API_URL="${{ env.API_BASE_URL }}/jobs/intraday-cpa-check"
          PARAMS=""

          if [ "$DRY_RUN" == "true" ]; then
            echo "=== DRY RUN MODE: No actual changes will be made ==="
            PARAMS="dryRun=true"
          fi

          if [ -n "$EXCLUDED" ]; then
            echo "=== Excluding advertisers: $EXCLUDED ==="
            if [ -n "$PARAMS" ]; then
              PARAMS="${PARAMS}&excludedAdvertisers=${EXCLUDED}"
            else
              PARAMS="excludedAdvertisers=${EXCLUDED}"
            fi
          fi

          if [ -n "$PARAMS" ]; then
            API_URL="${API_URL}?${PARAMS}"
          fi

          echo "Starting intraday CPA check at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            set +e
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 600 \
              --connect-timeout 30 \
              --retry 3 \
              --retry-delay 10 \
              --retry-all-errors \
              -X POST \
              "$API_URL")
            curl_exit_code=$?
            set -e

            if [ $curl_exit_code -ne 0 ]; then
              retry_count=$((retry_count + 1))
              echo "curl failed with exit code $curl_exit_code. Retry $retry_count/$max_retries..."
              sleep $((30 * retry_count))
              continue
            fi

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"

            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "Intraday CPA check completed successfully"
              echo "$body" | jq '.'
              success=true
              break
            else
              retry_count=$((retry_count + 1))
              echo "Request failed with status $http_code. Retry $retry_count/$max_retries..."
              echo "$body"
              sleep $((30 * retry_count))
            fi
          done

          if [ "$success" != true ]; then
            echo "Intraday CPA check failed after $max_retries retries"
            exit 1
          fi

  intraday-resume:
    runs-on: ubuntu-latest
    if: github.event.schedule == '59 14 * * *' || github.event.inputs.job_type == 'resume'
    steps:
      - name: Run Intraday Resume (23:59 JST)
        run: |
          echo "Starting intraday ad resume at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            set +e
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 300 \
              --connect-timeout 30 \
              --retry 3 \
              --retry-delay 10 \
              --retry-all-errors \
              -X POST \
              "${{ env.API_BASE_URL }}/jobs/intraday-resume")
            curl_exit_code=$?
            set -e

            if [ $curl_exit_code -ne 0 ]; then
              retry_count=$((retry_count + 1))
              echo "curl failed with exit code $curl_exit_code. Retry $retry_count/$max_retries..."
              sleep $((30 * retry_count))
              continue
            fi

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"

            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "Intraday ad resume completed successfully"
              echo "$body" | jq '.'
              success=true
              break
            else
              retry_count=$((retry_count + 1))
              echo "Request failed with status $http_code. Retry $retry_count/$max_retries..."
              echo "$body"
              sleep $((30 * retry_count))
            fi
          done

          if [ "$success" != true ]; then
            echo "Intraday ad resume failed after $max_retries retries"
            exit 1
          fi

  intraday-budget-restore:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 15 * * *' || github.event.inputs.job_type == 'budget-restore'
    steps:
      - name: Run Intraday Budget Restore (00:00 JST)
        run: |
          echo "Starting intraday budget restore at $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            set +e
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 300 \
              --connect-timeout 30 \
              --retry 3 \
              --retry-delay 10 \
              --retry-all-errors \
              -X POST \
              "${{ env.API_BASE_URL }}/jobs/intraday-budget-restore")
            curl_exit_code=$?
            set -e

            if [ $curl_exit_code -ne 0 ]; then
              retry_count=$((retry_count + 1))
              echo "curl failed with exit code $curl_exit_code. Retry $retry_count/$max_retries..."
              sleep $((30 * retry_count))
              continue
            fi

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"

            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "Intraday budget restore completed successfully"
              echo "$body" | jq '.'
              success=true
              break
            else
              retry_count=$((retry_count + 1))
              echo "Request failed with status $http_code. Retry $retry_count/$max_retries..."
              echo "$body"
              sleep $((30 * retry_count))
            fi
          done

          if [ "$success" != true ]; then
            echo "Intraday budget restore failed after $max_retries retries"
            exit 1
          fi
