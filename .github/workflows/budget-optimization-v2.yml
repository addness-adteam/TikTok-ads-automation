name: Hourly Budget Optimization V2

on:
  schedule:
    # JST 01:00ã€œ19:00 = UTC 16:00ã€œç¿Œ10:00ï¼ˆæ¯Žæ™‚å®Ÿè¡Œï¼‰
    - cron: '0 16,17,18,19,20,21,22,23 * * *'
    - cron: '0 0,1,2,3,4,5,6,7,8,9,10 * * *'
  workflow_dispatch:
    inputs:
      advertiser_ids:
        description: 'ç‰¹å®šã®Advertiser IDsã‚’ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã§æŒ‡å®šï¼ˆç©ºæ¬„ã§å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰'
        required: false
        type: string
      dry_run:
        description: 'ãƒ‰ãƒ©ã‚¤ãƒ©ãƒ³ï¼ˆå®Ÿéš›ã®äºˆç®—å¤‰æ›´ãªã—ï¼‰'
        required: false
        type: boolean
        default: false

env:
  API_BASE_URL: https://tik-tok-ads-automation-backend.vercel.app
  WAIT_BETWEEN_ACCOUNTS_SEC: 30
  # å¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ: ã‚¹ã‚­ãƒ«ãƒ—ãƒ©ã‚¹1ã‹ã‚‰é–‹å§‹
  SCHEDULED_ADVERTISER_IDS: '["7474920444831875080"]'

jobs:
  get-advertisers:
    runs-on: ubuntu-latest
    outputs:
      advertiser_ids: ${{ steps.get_ids.outputs.ids }}
    steps:
      - name: Get Active Advertiser IDs
        id: get_ids
        run: |
          if [ -n "${{ github.event.inputs.advertiser_ids }}" ]; then
            ids=$(echo "${{ github.event.inputs.advertiser_ids }}" | jq -R -c 'split(",")')
            echo "Using manually specified advertiser IDs: $ids"
          else
            ids='${{ env.SCHEDULED_ADVERTISER_IDS }}'
            echo "Using scheduled advertiser IDs: $ids"
          fi
          echo "ids=$ids" >> $GITHUB_OUTPUT

  optimize-budgets:
    runs-on: ubuntu-latest
    needs: get-advertisers
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        advertiser_id: ${{ fromJson(needs.get-advertisers.outputs.advertiser_ids) }}
    steps:
      - name: Check JST time
        id: time_check
        run: |
          jst_hour=$(TZ='Asia/Tokyo' date +%H)
          echo "JST hour: $jst_hour"
          echo "jst_hour=$jst_hour" >> $GITHUB_OUTPUT

          # 20:00ä»¥é™ã¯å®Ÿè¡Œã—ãªã„ï¼ˆã‚µãƒ¼ãƒ“ã‚¹å´ã§ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ãŒãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã§ã‚‚æ—©æœŸçµ‚äº†ï¼‰
          if [ "$jst_hour" -ge 20 ] || [ "$jst_hour" -lt 1 ]; then
            echo "Outside operation hours (JST $jst_hour). Skipping."
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: Wait before processing
        if: steps.time_check.outputs.skip != 'true'
        run: |
          echo "Waiting ${{ env.WAIT_BETWEEN_ACCOUNTS_SEC }} seconds..."
          sleep ${{ env.WAIT_BETWEEN_ACCOUNTS_SEC }}

      - name: V2 Budget Optimization for ${{ matrix.advertiser_id }}
        if: steps.time_check.outputs.skip != 'true'
        id: optimize
        run: |
          echo "Starting V2 budget optimization for: ${{ matrix.advertiser_id }} (JST ${{ steps.time_check.outputs.jst_hour }}:00)"

          dry_run_param="false"
          if [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            dry_run_param="true"
            echo "ðŸ§ª DRY RUN MODE"
          fi

          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            set +e
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 600 \
              --connect-timeout 30 \
              --retry 3 \
              --retry-delay 15 \
              --retry-max-time 180 \
              --retry-all-errors \
              -X POST \
              "${{ env.API_BASE_URL }}/api/budget-optimization-v2/execute/${{ matrix.advertiser_id }}" \
              -H "Content-Type: application/json" \
              -d "{\"dryRun\": $dry_run_param}")
            curl_exit_code=$?
            set -e

            if [ $curl_exit_code -ne 0 ]; then
              retry_count=$((retry_count + 1))
              echo "âš ï¸ curl failed (exit code $curl_exit_code). Retry $retry_count/$max_retries..."
              if [ $retry_count -lt $max_retries ]; then
                sleep $((30 * retry_count))
                continue
              else
                echo "âŒ Failed after $max_retries retries"
                break
              fi
            fi

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"

            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              # ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®successãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
              api_success=$(echo "$body" | jq -r '.success // false')
              if [ "$api_success" != "true" ]; then
                api_error=$(echo "$body" | jq -r '.error // "Unknown error"')
                echo "âŒ API returned error: $api_error"
                break
              fi
              echo "âœ… Success for ${{ matrix.advertiser_id }}"
              echo ""

              # å®Ÿè¡Œçµæžœã‚µãƒžãƒªãƒ¼
              echo "=== ðŸ“Š V2 å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ ==="
              is_first=$(echo "$body" | jq -r '.data.isFirstRound // false')
              if [ "$is_first" = "true" ]; then
                echo "ðŸ”µ ç¬¬1å›žå®Ÿè¡Œï¼ˆStage1: å½“æ—¥CPAå¢—é¡ + Stage2: åœæ­¢åˆ¤å®šï¼‰"
              else
                echo "ðŸŸ¢ ç¬¬2å›žä»¥é™ï¼ˆå·®åˆ†CVå¢—é¡ã®ã¿ï¼‰"
              fi
              echo "$body" | jq -r '.data.summary | "ç·åºƒå‘Šæ•°: \(.totalAds) | å¢—é¡: \(.increased) | ç¶™ç¶š: \(.continued) | åœæ­¢: \(.paused) | ã‚¹ã‚­ãƒƒãƒ—: \(.skipped)"'
              echo ""

              # Stage1çµæžœ
              stage1_count=$(echo "$body" | jq -r '.data.stage1Results | length')
              if [ "$stage1_count" -gt 0 ]; then
                echo "=== ðŸ’° Stage1: äºˆç®—å¢—é¡åˆ¤å®š ==="
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "$body" | jq -r '.data.stage1Results[] |
                  "[\(.action)] \(.adName)\n" +
                  "  ðŸ’° æ—¥äºˆç®—: Â¥\(.currentBudget // 0)" +
                  (if .newBudget then " â†’ Â¥\(.newBudget)" else "" end) + "\n" +
                  "  ðŸ“ˆ å½“æ—¥CPA: \(if .todayCPA then "Â¥\(.todayCPA | floor)" else "N/A" end) | å½“æ—¥CV: \(.todayCV) | å½“æ—¥åºƒå‘Šè²»: Â¥\(.todaySpend // 0 | floor)\n" +
                  "  ðŸ“ \(.reason)\n" +
                  "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"'
                echo ""
              fi

              # Stage2çµæžœï¼ˆç¬¬1å›žã®ã¿ï¼‰
              stage2_count=$(echo "$body" | jq -r '.data.stage2Results | length')
              if [ "$stage2_count" -gt 0 ]; then
                echo "=== ðŸ›‘ Stage2: åœæ­¢åˆ¤å®š ==="
                echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                echo "$body" | jq -r '.data.stage2Results[] |
                  "[\(.action)] \(.adName)\n" +
                  "  ðŸ“Š éŽåŽ»7æ—¥: åºƒå‘Šè²»=Â¥\(.last7DaysSpend // 0 | floor) | CV=\(.last7DaysCVCount) | ãƒ•ãƒ­ãƒ³ãƒˆè²©å£²=\(.last7DaysFrontSalesCount)\n" +
                  "  ðŸ’° CPA: \(if .last7DaysCPA then "Â¥\(.last7DaysCPA | floor)" else "N/A" end) | ãƒ•ãƒ­ãƒ³ãƒˆCPO: \(if .last7DaysFrontCPO then "Â¥\(.last7DaysFrontCPO | floor)" else "N/A" end)\n" +
                  "  ðŸ“ \(.reason)\n" +
                  "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"'
                echo ""
              fi

              success=true
              break
            elif [ "$http_code" -eq 429 ]; then
              retry_count=$((retry_count + 1))
              wait_time=$((60 * retry_count))
              echo "âš ï¸ Rate limited. Waiting ${wait_time}s (retry $retry_count/$max_retries)"
              sleep $wait_time
            else
              echo "âŒ Error: $http_code"
              echo "$body"
              break
            fi
          done

          if [ "$success" = true ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

  summary:
    runs-on: ubuntu-latest
    needs: [get-advertisers, optimize-budgets]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          jst_time=$(TZ='Asia/Tokyo' date '+%Y-%m-%d %H:%M JST')
          echo "## V2 Budget Optimization Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $jst_time" >> $GITHUB_STEP_SUMMARY
          echo "- **Accounts**: ${{ needs.get-advertisers.outputs.advertiser_ids }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY
