name: Daily TikTok Metrics Collection

on:
  schedule:
    # 毎日0時5分（日本時間）= 15時5分（UTC前日）
    - cron: '5 15 * * *'
  workflow_dispatch: # 手動実行も可能

env:
  API_BASE_URL: https://tik-tok-ads-automation-backend.vercel.app

jobs:
  # Step 1: アクティブなAdvertiser IDを取得
  get-advertisers:
    runs-on: ubuntu-latest
    outputs:
      advertiser_ids: ${{ steps.get_ids.outputs.ids }}
    steps:
      - name: Get Active Advertiser IDs
        id: get_ids
        run: |
          echo "Fetching active advertiser IDs..."

          response=$(curl -s "${{ env.API_BASE_URL }}/jobs/diagnostics")

          # jqでadvertiserIdを抽出してJSON配列を作成
          ids=$(echo "$response" | jq -c '[.oauthTokens.tokens[].advertiserId]')

          echo "Found advertiser IDs: $ids"
          echo "ids=$ids" >> $GITHUB_OUTPUT

  # Step 2: 各Advertiserのエンティティを順番に同期
  sync-entities:
    runs-on: ubuntu-latest
    needs: get-advertisers
    strategy:
      fail-fast: false
      max-parallel: 1
      matrix:
        advertiser_id: ${{ fromJson(needs.get-advertisers.outputs.advertiser_ids) }}
    steps:
      - name: Sync Entities for ${{ matrix.advertiser_id }}
        run: |
          echo "Syncing entities for advertiser: ${{ matrix.advertiser_id }}"

          response=$(curl -s -w "\n%{http_code}" --max-time 300 -X POST \
            "${{ env.API_BASE_URL }}/jobs/sync-entities?advertiserId=${{ matrix.advertiser_id }}")

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Warning: Entity sync failed for ${{ matrix.advertiser_id }} with status $http_code"
            # 1つのアカウントが失敗しても続行する（fail-fast: false）
          else
            echo "Entity sync completed for ${{ matrix.advertiser_id }}"
          fi

  # Step 3: メトリクス取得（エンティティ同期の後に実行）
  collect-metrics:
    runs-on: ubuntu-latest
    needs: sync-entities
    if: always()
    steps:
      - name: Collect Daily Metrics
        run: |
          echo "Triggering daily metrics collection..."

          response=$(curl -s -w "\n%{http_code}" --max-time 300 -X POST \
            ${{ env.API_BASE_URL }}/jobs/run-daily-report)

          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | sed '$d')

          echo "Response: $body"
          echo "HTTP Status: $http_code"

          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Error: Metrics collection failed with status $http_code"
            exit 1
          fi

          echo "Daily metrics collection completed successfully"
