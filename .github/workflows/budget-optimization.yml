name: Daily Budget Optimization

on:
  schedule:
    # æ¯Žæ—¥3æ™‚ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰= 18æ™‚ï¼ˆUTCå‰æ—¥ï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch:
    inputs:
      advertiser_ids:
        description: 'ç‰¹å®šã®Advertiser IDsã‚’ã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šã§æŒ‡å®šï¼ˆç©ºæ¬„ã§å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰'
        required: false
        type: string

env:
  API_BASE_URL: https://tik-tok-ads-automation-backend.vercel.app
  WAIT_BETWEEN_ACCOUNTS_SEC: 60
  # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã®å¯¾è±¡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆã‚«ãƒ³ãƒžåŒºåˆ‡ã‚Šï¼‰
  # NOTE: SS1 (7247073333517238273) ã¯ä¸€æ™‚çš„ã«é™¤å¤–ä¸­
  # NOTE: AI_1 (7468288053866561553) ã¯ä¸€æ™‚çš„ã«é™¤å¤–ä¸­
  SCHEDULED_ADVERTISER_IDS: '["7543540381615800337","7523128243466551303","7543540647266074641"]'

jobs:
  # Step 1: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªAdvertiser IDã‚’å–å¾—
  get-advertisers:
    runs-on: ubuntu-latest
    outputs:
      advertiser_ids: ${{ steps.get_ids.outputs.ids }}
    steps:
      - name: Get Active Advertiser IDs
        id: get_ids
        run: |
          if [ -n "${{ github.event.inputs.advertiser_ids }}" ]; then
            # æ‰‹å‹•å®Ÿè¡Œæ™‚ã¯æŒ‡å®šã•ã‚ŒãŸIDã‚’ä½¿ç”¨
            ids=$(echo "${{ github.event.inputs.advertiser_ids }}" | jq -R -c 'split(",")')
            echo "Using manually specified advertiser IDs: $ids"
          else
            # ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œæ™‚ã¯å›ºå®šã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒªã‚¹ãƒˆã‚’ä½¿ç”¨
            ids='${{ env.SCHEDULED_ADVERTISER_IDS }}'
            echo "Using scheduled advertiser IDs: $ids"
          fi

          echo "ids=$ids" >> $GITHUB_OUTPUT

  # Step 2: å„ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®äºˆç®—æœ€é©åŒ–ã‚’é †æ¬¡å®Ÿè¡Œ
  optimize-budgets:
    runs-on: ubuntu-latest
    needs: get-advertisers
    strategy:
      fail-fast: false
      max-parallel: 1  # é‡è¦: é †æ¬¡å®Ÿè¡Œã§ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚’å›žé¿
      matrix:
        advertiser_id: ${{ fromJson(needs.get-advertisers.outputs.advertiser_ids) }}
    steps:
      - name: Wait before processing
        run: |
          echo "Waiting ${{ env.WAIT_BETWEEN_ACCOUNTS_SEC }} seconds before processing..."
          sleep ${{ env.WAIT_BETWEEN_ACCOUNTS_SEC }}

      - name: Optimize Budget for ${{ matrix.advertiser_id }}
        id: optimize
        run: |
          echo "Starting budget optimization for: ${{ matrix.advertiser_id }}"

          # æœ€å¤§3å›žãƒªãƒˆãƒ©ã‚¤
          max_retries=3
          retry_count=0
          success=false

          while [ $retry_count -lt $max_retries ]; do
            # curlã‚’å®Ÿè¡Œã—ã€çµ‚äº†ã‚³ãƒ¼ãƒ‰ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
            # mode: ROAS_MAXIMIZEï¼ˆROASæœ€å¤§åŒ–ãƒ¢ãƒ¼ãƒ‰ï¼‰ã‚’ä½¿ç”¨
            # --retry-all-errors: SSLæŽ¥ç¶šã‚¨ãƒ©ãƒ¼(exit code 35)ã‚’å«ã‚€å…¨ã‚¨ãƒ©ãƒ¼ã§ãƒªãƒˆãƒ©ã‚¤
            # --connect-timeout 30: æŽ¥ç¶šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’30ç§’ã«è¨­å®š
            set +e  # ã‚¨ãƒ©ãƒ¼ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’çµ‚äº†ã—ãªã„
            response=$(curl -s -w "\n%{http_code}" \
              --max-time 600 \
              --connect-timeout 30 \
              --retry 5 \
              --retry-delay 15 \
              --retry-max-time 300 \
              --retry-all-errors \
              -X POST \
              "${{ env.API_BASE_URL }}/api/optimization/execute/${{ matrix.advertiser_id }}" \
              -H "Content-Type: application/json" \
              -d '{"mode": "ROAS_MAXIMIZE"}')
            curl_exit_code=$?
            set -e

            # curlãŒå¤±æ•—ã—ãŸå ´åˆï¼ˆSSL/æŽ¥ç¶šã‚¨ãƒ©ãƒ¼ãªã©ï¼‰
            if [ $curl_exit_code -ne 0 ]; then
              retry_count=$((retry_count + 1))
              echo "âš ï¸ curl failed with exit code $curl_exit_code. Retry $retry_count/$max_retries..."
              if [ $retry_count -lt $max_retries ]; then
                sleep $((30 * retry_count))
                continue
              else
                echo "âŒ curl failed after $max_retries retries (exit code: $curl_exit_code)"
                break
              fi
            fi

            http_code=$(echo "$response" | tail -n1)
            body=$(echo "$response" | sed '$d')

            echo "HTTP Status: $http_code"

            if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
              echo "âœ… Success for ${{ matrix.advertiser_id }}"
              echo ""

              # ã‚µãƒžãƒªãƒ¼æƒ…å ±ã‚’å‡ºåŠ›
              echo "=== ðŸ“Š å®Ÿè¡Œã‚µãƒžãƒªãƒ¼ ==="
              echo "$body" | jq -r '.data | "ç·åºƒå‘Šæ•°: \(.totalAds // 0) | è©•ä¾¡æ¸ˆã¿: \(.evaluated // 0) | åˆ¤å®šæ•°: \(.decisions // 0) | å®Ÿè¡Œæ•°: \(.executed // 0)"'
              echo ""

              # ç›®æ¨™å€¤ã‚’å‡ºåŠ›
              echo "=== ðŸŽ¯ ç›®æ¨™å€¤ ==="
              echo "$body" | jq -r '.data.detailedLogs[0]?.targets | "ç›®æ¨™CPA: \(.targetCPA // "æœªè¨­å®š")å†† | è¨±å®¹CPA: \(.allowableCPA // "æœªè¨­å®š")å†† | ç›®æ¨™ãƒ•ãƒ­ãƒ³ãƒˆCPO: \(.targetFrontCPO // "æœªè¨­å®š")å†† | è¨±å®¹ãƒ•ãƒ­ãƒ³ãƒˆCPO: \(.allowableFrontCPO // "æœªè¨­å®š")å††"'
              echo ""

              # å„åºƒå‘Šã®è©³ç´°åˆ¤å®šçµæžœã‚’å‡ºåŠ›
              echo "=== ðŸ“‹ åºƒå‘Šåˆ¥åˆ¤å®šçµæžœï¼ˆè©³ç´°ï¼‰ ==="
              echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
              echo "$body" | jq -r '.data.detailedLogs[]? |
                "åºƒå‘Šå: \(.adName // .adId)\n" +
                "  ðŸ“ˆ æŒ‡æ¨™: åºƒå‘Šè²»=\(.metrics.spend // 0)å†† | CVæ•°=\(.metrics.cvCount // 0) | ãƒ•ãƒ­ãƒ³ãƒˆè²©å£²=\(.metrics.frontSalesCount // 0)æœ¬\n" +
                "  ðŸ’° å®Ÿç¸¾: CPA=\(.metrics.cpa // "N/A")å†† | ãƒ•ãƒ­ãƒ³ãƒˆCPO=\(.metrics.frontCpo // "N/A")å††\n" +
                "  ðŸŽ¬ åˆ¤å®š: [\(.action // "N/A")] \(.reason // "ç†ç”±ãªã—")\n" +
                "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"'
              echo ""

              # Smart+ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³ã®çµæžœ
              smart_plus_count=$(echo "$body" | jq -r '.data.smartPlusCampaigns.total // 0')
              if [ "$smart_plus_count" -gt 0 ]; then
                echo "=== ðŸš€ Smart+ã‚­ãƒ£ãƒ³ãƒšãƒ¼ãƒ³çµæžœ ==="
                echo "$body" | jq -r '.data.smartPlusCampaigns.results[]? | "[\(.action // "N/A")] Campaign: \(.campaignId // .adgroupId) - äºˆç®—: \(.oldBudget // "?") â†’ \(.newBudget // "?")"'
                echo ""
              fi

              # ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸåºƒå‘Šã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
              cooldown_count=$(echo "$body" | jq -r '[.data.results[]? | select(.action == "SKIPPED_DUE_TO_COOLDOWN")] | length')
              if [ "$cooldown_count" -gt 0 ]; then
                echo "=== â¸ï¸ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã§ã‚¹ã‚­ãƒƒãƒ—ï¼ˆ3æ—¥ä»¥å†…ã«å¢—é¡æ¸ˆã¿ï¼‰ ==="
                echo "$body" | jq -r '.data.results[]? | select(.action == "SKIPPED_DUE_TO_COOLDOWN") | "AdGroup: \(.adgroupId) - \(.reason // "ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ä¸­")"'
                echo ""
              fi

              # ä¸Šé™æ—¥äºˆç®—ã§ã‚¹ã‚­ãƒƒãƒ—ã•ã‚ŒãŸåºƒå‘Šã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
              cap_count=$(echo "$body" | jq -r '[.data.results[]? | select(.action == "SKIPPED_DUE_TO_CAP")] | length')
              if [ "$cap_count" -gt 0 ]; then
                echo "=== ðŸ”’ ä¸Šé™æ—¥äºˆç®—ã§ã‚¹ã‚­ãƒƒãƒ— ==="
                echo "$body" | jq -r '.data.results[]? | select(.action == "SKIPPED_DUE_TO_CAP") | "AdGroup: \(.adgroupId) - \(.reason // "ä¸Šé™æ—¥äºˆç®—ã«åˆ°é”")"'
                echo ""
              fi

              # ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°å‡ºåŠ›
              has_errors=$(echo "$body" | jq -r '.data.results[]? | select(.success == false) | .adgroupId' | head -1)
              if [ -n "$has_errors" ]; then
                echo "=== âš ï¸ ã‚¨ãƒ©ãƒ¼è©³ç´° ==="
                echo "$body" | jq -r '.data.results[]? | select(.success == false) | "AdGroup: \(.adgroupId) - \(.error // "ä¸æ˜Žãªã‚¨ãƒ©ãƒ¼")"'
                echo ""
              fi

              success=true
              break
            elif [ "$http_code" -eq 429 ]; then
              # ãƒ¬ãƒ¼ãƒˆåˆ¶é™: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
              retry_count=$((retry_count + 1))
              wait_time=$((60 * retry_count))
              echo "âš ï¸ Rate limited. Waiting ${wait_time}s before retry $retry_count/$max_retries..."
              sleep $wait_time
            else
              echo "âŒ Error for ${{ matrix.advertiser_id }}: $http_code"
              echo "$body"
              break
            fi
          done

          if [ "$success" = true ]; then
            echo "result=success" >> $GITHUB_OUTPUT
          else
            echo "result=failed" >> $GITHUB_OUTPUT
          fi

  # Step 3: çµæžœã‚µãƒžãƒªãƒ¼
  summary:
    runs-on: ubuntu-latest
    needs: [get-advertisers, optimize-budgets]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "## Budget Optimization Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Execution Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Accounts Processed**: ${{ needs.get-advertisers.outputs.advertiser_ids }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See job logs for detailed results." >> $GITHUB_STEP_SUMMARY
